<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åæ ‡è½¬æ¢å·¥å…·</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #fafafa;
        }
        .section h2 {
            color: #555;
            margin-top: 0;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }
        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        button {
            background-color: #28a745;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
        }
        button:hover {
            background-color: #218838;
        }
        .success {
            color: #28a745;
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .error {
            color: #dc3545;
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .result-section {
            margin-top: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #f8f9fa;
        }
        pre {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
            white-space: pre-wrap;
        }
        .coord-input {
            display: flex;
            gap: 10px;
        }
        .coord-input input {
            flex: 1;
        }
        .transform-pairs {
            margin-top: 15px;
        }
        .pair-category {
            margin-bottom: 20px;
        }
        .pair-category h4 {
            margin: 0 0 10px 0;
            color: #1976d2;
            font-size: 16px;
        }
        .pair {
            background-color: #e3f2fd;
            padding: 12px;
            border-radius: 4px;
            margin-bottom: 8px;
            font-weight: 500;
            border-left: 4px solid #1976d2;
        }
        .pair:last-child {
            margin-bottom: 0;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 4px;
            border: 1px solid #c3e6cb;
            margin-bottom: 15px;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 4px;
            border: 1px solid #f5c6cb;
            margin-bottom: 15px;
        }
        .result-section {
            margin-top: 30px;
        }
        .result-section h2 {
            color: #333;
            border-bottom: 2px solid #1976d2;
            padding-bottom: 10px;
        }
        #resultContainer {
            min-height: 100px;
            padding: 20px;
            background-color: #fafafa;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ—ºï¸ åæ ‡è½¬æ¢å·¥å…·</h1>

        <!-- å¯¼èˆªèœå• -->
        <div style="margin-bottom: 30px; padding: 15px; background-color: #ecf0f1; border-radius: 5px;">
            <h3>åŠŸèƒ½å¯¼èˆª</h3>
            <a href="index.html" style="margin-right: 20px; color: #28a745; text-decoration: none;">ğŸ  åŸºç¡€ä¸Šä¼ </a>
            <a href="template-upload.html" style="margin-right: 20px; color: #28a745; text-decoration: none;">ğŸ“‹ æ¨¡æ¿ä¸Šä¼ </a>
            <a href="coordinate-transform.html" style="color: #28a745; text-decoration: none; font-weight: bold;">ğŸ—ºï¸ åæ ‡è½¬æ¢</a>
        </div>

        <!-- åæ ‡è½¬æ¢åŒºåŸŸ -->
        <div class="section">
            <h2>ğŸ”„ åæ ‡ç³»è½¬æ¢</h2>
            <div class="form-group">
                <label>æºåæ ‡ç³»:</label>
                <select id="sourceCoordSystem" onchange="updateCoordSystemInfo()">
                    <option value="CGCS2000">CGCS2000 (ä¸­å›½å¤§åœ°åæ ‡ç³»2000 - ç»çº¬åº¦)</option>
                    <option value="CGCS2000XY">CGCS2000XY (ä¸­å›½å¤§åœ°åæ ‡ç³»2000 - æŠ•å½±åæ ‡)</option>
                    <option value="WenZhou2000">WenZhou2000 (æ¸©å·2000åæ ‡ç³» - æŠ•å½±åæ ‡)</option>
                    <option value="WenZhouCity">WenZhouCity (æ¸©å·åŸå¸‚åæ ‡ç³» - æŠ•å½±åæ ‡)</option>
                    <option value="Beijing1954">Beijing1954 (åŒ—äº¬1954åæ ‡ç³» - æŠ•å½±åæ ‡)</option>
                </select>
            </div>
            <div class="form-group">
                <label>ç›®æ ‡åæ ‡ç³»:</label>
                <select id="targetCoordSystem" onchange="updateCoordSystemInfo()">
                    <option value="CGCS2000">CGCS2000 (ä¸­å›½å¤§åœ°åæ ‡ç³»2000 - ç»çº¬åº¦)</option>
                    <option value="CGCS2000XY">CGCS2000XY (ä¸­å›½å¤§åœ°åæ ‡ç³»2000 - æŠ•å½±åæ ‡)</option>
                    <option value="WenZhou2000">WenZhou2000 (æ¸©å·2000åæ ‡ç³» - æŠ•å½±åæ ‡)</option>
                    <option value="WenZhouCity">WenZhouCity (æ¸©å·åŸå¸‚åæ ‡ç³» - æŠ•å½±åæ ‡)</option>
                    <option value="Beijing1954">Beijing1954 (åŒ—äº¬1954åæ ‡ç³» - æŠ•å½±åæ ‡)</option>
                </select>
            </div>

            <!-- åæ ‡ç³»ä¿¡æ¯æç¤º -->
            <div id="coordSystemInfo" class="form-group" style="background-color: #e3f2fd; padding: 15px; border-radius: 4px; margin: 15px 0;">
                <small id="coordSystemInfoText">è¯·é€‰æ‹©æºåæ ‡ç³»å’Œç›®æ ‡åæ ‡ç³»</small>
            </div>

            <div class="form-group">
                <label>è¾“å…¥åæ ‡:</label>
                <div class="coord-input">
                    <input type="number" id="inputX" placeholder="Xåæ ‡ (ç»åº¦)" step="any">
                    <input type="number" id="inputY" placeholder="Yåæ ‡ (çº¬åº¦)" step="any">
                </div>
                <small style="color: #666; margin-top: 5px; display: block;">
                    <span id="coordInputHint">è¯·æ ¹æ®æºåæ ‡ç³»ç±»å‹è¾“å…¥ç›¸åº”çš„åæ ‡å€¼</span>
                </small>
            </div>

            <!-- åæ ‡ç¤ºä¾‹ -->
            <div class="form-group">
                <label>åæ ‡ç¤ºä¾‹:</label>
                <div style="background-color: #f8f9fa; padding: 15px; border-radius: 4px; font-size: 13px;">
                    <div style="margin-bottom: 8px;"><strong>ç»çº¬åº¦åæ ‡ (CGCS2000):</strong> X=120.672, Y=28.0</div>
                    <div style="margin-bottom: 8px;"><strong>æ¸©å·æŠ•å½±åæ ‡ (WenZhou2000):</strong> X=337641.456, Y=3379401.623</div>
                    <div style="margin-bottom: 8px;"><strong>å›½å®¶æŠ•å½±åæ ‡ (CGCS2000XY):</strong> X=566100.0, Y=3098623.7</div>
                    <div><strong>æ¸©å·åŸå¸‚åæ ‡ (WenZhouCity):</strong> X=338000, Y=3380000</div>
                </div>
            </div>

            <div class="form-group">
                <button onclick="autoDetectCoordType()" style="background-color: #17a2b8; margin-right: 10px;">ğŸ” è‡ªåŠ¨æ£€æµ‹åæ ‡ç±»å‹</button>
                <button onclick="transformCoordinate()" style="background-color: #28a745; margin-right: 10px;">ğŸ”„ è½¬æ¢åæ ‡</button>
                <button onclick="clearInputs()" style="background-color: #6c757d;">ğŸ—‘ï¸ æ¸…ç©ºè¾“å…¥</button>
            </div>
        </div>

        <!-- æ”¯æŒçš„è½¬æ¢å¯¹ -->
        <div class="section">
            <h2>ğŸ“‹ æ”¯æŒçš„è½¬æ¢å¯¹</h2>
            <div class="transform-pairs">
                <div class="pair-category">
                    <h4>ğŸ”„ ç›´æ¥è½¬æ¢å¯¹</h4>
                    <div class="pair">WenZhou2000 â†’ WenZhouCity (æ¸©å·2000 â†’ æ¸©å·åŸå¸‚)</div>
                    <div class="pair">Beijing1954 â†’ WenZhouCity (åŒ—äº¬1954 â†’ æ¸©å·åŸå¸‚)</div>
                    <div class="pair">WenZhou2000 â†’ CGCS2000 (æ¸©å·2000 â†’ å›½å®¶ç»çº¬åº¦)</div>
                    <div class="pair">CGCS2000XY â†’ CGCS2000 (å›½å®¶æŠ•å½± â†’ å›½å®¶ç»çº¬åº¦)</div>
                </div>
                <div class="pair-category">
                    <h4>â†©ï¸ åå‘è½¬æ¢å¯¹</h4>
                    <div class="pair">WenZhouCity â†’ WenZhou2000 (æ¸©å·åŸå¸‚ â†’ æ¸©å·2000)</div>
                    <div class="pair">WenZhouCity â†’ Beijing1954 (æ¸©å·åŸå¸‚ â†’ åŒ—äº¬1954)</div>
                    <div class="pair">CGCS2000 â†’ WenZhou2000 (å›½å®¶ç»çº¬åº¦ â†’ æ¸©å·2000)</div>
                    <div class="pair">CGCS2000 â†’ CGCS2000XY (å›½å®¶ç»çº¬åº¦ â†’ å›½å®¶æŠ•å½±)</div>
                </div>
                <div class="pair-category">
                    <h4>ğŸ¯ å¸¸ç”¨è½¬æ¢åœºæ™¯</h4>
                    <div class="pair" style="background-color: #e8f5e8;">ç»çº¬åº¦æ•°æ® (120.672, 28.0) â†’ ä½¿ç”¨ CGCS2000</div>
                    <div class="pair" style="background-color: #fff3e0;">æ¸©å·æŠ•å½±åæ ‡ (337641, 3379401) â†’ ä½¿ç”¨ WenZhou2000</div>
                    <div class="pair" style="background-color: #f3e5f5;">å›½å®¶æŠ•å½±åæ ‡ (566100, 3098623) â†’ ä½¿ç”¨ CGCS2000XY</div>
                    <div class="pair" style="background-color: #e1f5fe;">æ¸©å·åŸå¸‚åæ ‡ (338000, 3380000) â†’ ä½¿ç”¨ WenZhouCity</div>
                </div>
            </div>
        </div>

        <!-- æ‰¹é‡è½¬æ¢åŒºåŸŸ -->
        <div class="section">
            <h2>ğŸ“Š æ‰¹é‡åæ ‡è½¬æ¢</h2>
            <div class="form-group">
                <label>æ‰¹é‡åæ ‡è¾“å…¥ (æ¯è¡Œä¸€ä¸ªåæ ‡å¯¹ï¼Œæ ¼å¼: X,Y):</label>
                <textarea id="batchCoords" rows="8" placeholder="ä¾‹å¦‚:
116.3974, 39.9093
121.4737, 31.2304
113.2644, 23.1291"></textarea>
            </div>
            <div class="form-group">
                <button onclick="batchTransform()">æ‰¹é‡è½¬æ¢</button>
            </div>
        </div>

        <!-- ç»“æœæ˜¾ç¤ºåŒºåŸŸ -->
        <div class="result-section">
            <h2>ğŸ“‹ è½¬æ¢ç»“æœ</h2>
            <div id="resultContainer">
                <p>ç­‰å¾…è½¬æ¢ç»“æœ...</p>
            </div>
        </div>
    </div>

    <script>
        // åæ ‡ç³»ä¿¡æ¯é…ç½®
        const coordSystemInfo = {
            'CGCS2000': {
                type: 'ç»çº¬åº¦åæ ‡',
                ellipsoid: 'CGCS2000',
                centralMeridian: '120Â°',
                usage: 'ä¸­å›½å¤§åœ°åæ ‡ç³»2000ï¼Œç»çº¬åº¦åæ ‡',
                range: 'å…¨å›½é€šç”¨',
                example: 'X=120.672, Y=28.0'
            },
            'CGCS2000XY': {
                type: 'æŠ•å½±åæ ‡',
                ellipsoid: 'CGCS2000',
                centralMeridian: '120Â°',
                usage: 'ä¸­å›½å¤§åœ°åæ ‡ç³»2000ï¼ŒæŠ•å½±åæ ‡',
                range: 'å…¨å›½é€šç”¨',
                example: 'X=566100.0, Y=3098623.7'
            },
            'WenZhou2000': {
                type: 'æŠ•å½±åæ ‡',
                ellipsoid: 'CGCS2000',
                centralMeridian: '120.666667Â°',
                usage: 'æ¸©å·2000åæ ‡ç³»ï¼ŒæŠ•å½±åæ ‡',
                range: 'æ¸©å·åœ°åŒº',
                example: 'X=337641.456, Y=3379401.623'
            },
            'WenZhouCity': {
                type: 'æŠ•å½±åæ ‡',
                ellipsoid: 'Beijing1954',
                centralMeridian: '120.666667Â°',
                usage: 'æ¸©å·åŸå¸‚åæ ‡ç³»ï¼ŒæŠ•å½±åæ ‡',
                range: 'æ¸©å·åŸåŒº',
                example: 'X=338000, Y=3380000'
            },
            'Beijing1954': {
                type: 'æŠ•å½±åæ ‡',
                ellipsoid: 'Beijing1954',
                centralMeridian: '120Â°',
                usage: 'åŒ—äº¬1954åæ ‡ç³»ï¼ŒæŠ•å½±åæ ‡',
                range: 'å†å²åæ ‡ç³»',
                example: 'X=338500, Y=3380500'
            }
        };

        // æ›´æ–°åæ ‡ç³»ä¿¡æ¯æ˜¾ç¤º
        function updateCoordSystemInfo() {
            const sourceCoord = document.getElementById('sourceCoordSystem').value;
            const targetCoord = document.getElementById('targetCoordSystem').value;
            const infoElement = document.getElementById('coordSystemInfoText');
            const hintElement = document.getElementById('coordInputHint');

            if (sourceCoord && targetCoord) {
                const sourceInfo = coordSystemInfo[sourceCoord];
                const targetInfo = coordSystemInfo[targetCoord];

                infoElement.innerHTML = `
                    <strong>æºåæ ‡ç³»:</strong> ${sourceInfo.usage} (${sourceInfo.type})<br>
                    <strong>ç›®æ ‡åæ ‡ç³»:</strong> ${targetInfo.usage} (${targetInfo.type})<br>
                    <strong>è½¬æ¢æ–¹å‘:</strong> ${sourceCoord} â†’ ${targetCoord}
                `;

                hintElement.innerHTML = `è¯·è¾“å…¥${sourceInfo.type}æ ¼å¼çš„åæ ‡ï¼Œç¤ºä¾‹: ${sourceInfo.example}`;

                // æ›´æ–°è¾“å…¥æ¡†å ä½ç¬¦
                if (sourceInfo.type === 'ç»çº¬åº¦åæ ‡') {
                    document.getElementById('inputX').placeholder = 'Xåæ ‡ (ç»åº¦)';
                    document.getElementById('inputY').placeholder = 'Yåæ ‡ (çº¬åº¦)';
                } else {
                    document.getElementById('inputX').placeholder = 'Xåæ ‡ (æŠ•å½±)';
                    document.getElementById('inputY').placeholder = 'Yåæ ‡ (æŠ•å½±)';
                }
            } else {
                infoElement.innerHTML = 'è¯·é€‰æ‹©æºåæ ‡ç³»å’Œç›®æ ‡åæ ‡ç³»';
                hintElement.innerHTML = 'è¯·æ ¹æ®æºåæ ‡ç³»ç±»å‹è¾“å…¥ç›¸åº”çš„åæ ‡å€¼';
            }
        }

        // è‡ªåŠ¨æ£€æµ‹åæ ‡ç±»å‹
        function autoDetectCoordType() {
            const inputX = parseFloat(document.getElementById('inputX').value);
            const inputY = parseFloat(document.getElementById('inputY').value);

            if (isNaN(inputX) || isNaN(inputY)) {
                showError('è¯·å…ˆè¾“å…¥åæ ‡å€¼');
                return;
            }

            let detectedType = 'UNKNOWN';
            let confidence = '';

            // æ£€æŸ¥æ˜¯å¦ä¸ºç»çº¬åº¦åæ ‡
            if (inputX >= -180 && inputX <= 180 && inputY >= -90 && inputY <= 90) {
                detectedType = 'CGCS2000';
                confidence = 'é«˜';
            }
            // æ£€æŸ¥æ˜¯å¦ä¸ºæ¸©å·åœ°åŒºæŠ•å½±åæ ‡
            else if (inputX >= 200000 && inputX <= 500000 && inputY >= 3000000 && inputY <= 3500000) {
                detectedType = 'WenZhou2000';
                confidence = 'é«˜';
            }
            // æ£€æŸ¥æ˜¯å¦ä¸ºå›½å®¶æŠ•å½±åæ ‡
            else if (inputX >= -2000000 && inputX <= 2000000 && inputY >= 1000000 && inputY <= 6000000) {
                detectedType = 'CGCS2000XY';
                confidence = 'ä¸­';
            }

            if (detectedType !== 'UNKNOWN') {
                document.getElementById('sourceCoordSystem').value = detectedType;
                updateCoordSystemInfo();
                showSuccess(`ğŸ” è‡ªåŠ¨æ£€æµ‹ç»“æœï¼š\nåæ ‡ç±»å‹: ${detectedType}\nç½®ä¿¡åº¦: ${confidence}\nå»ºè®®: ${coordSystemInfo[detectedType].usage}`);
            } else {
                showError('ğŸ” æ— æ³•è‡ªåŠ¨æ£€æµ‹åæ ‡ç±»å‹ï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©åæ ‡ç³»');
            }
        }

        // å•ä¸ªåæ ‡è½¬æ¢
        async function transformCoordinate() {
            const inputX = parseFloat(document.getElementById('inputX').value);
            const inputY = parseFloat(document.getElementById('inputY').value);
            const sourceCoordSystem = document.getElementById('sourceCoordSystem').value;
            const targetCoordSystem = document.getElementById('targetCoordSystem').value;

            if (isNaN(inputX) || isNaN(inputY)) {
                showError('è¯·è¾“å…¥æœ‰æ•ˆçš„åæ ‡å€¼');
                return;
            }

            if (sourceCoordSystem === targetCoordSystem) {
                showError('æºåæ ‡ç³»å’Œç›®æ ‡åæ ‡ç³»ç›¸åŒï¼Œæ— éœ€è½¬æ¢');
                return;
            }

            const wkt = `POINT(${inputX} ${inputY})`;

            try {
                const response = await fetch('/api/coordinate/transform', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        wkt: wkt,
                        sourceCoordSystem: sourceCoordSystem,
                        targetCoordSystem: targetCoordSystem
                    })
                });

                if (response.ok) {
                    const result = await response.text();

                    // æ£€æŸ¥è¿”å›çš„æ˜¯å¦æ˜¯JSONæ ¼å¼ï¼ˆé”™è¯¯æƒ…å†µï¼‰
                    if (result.startsWith('{') && result.includes('transformedWkt')) {
                        try {
                            const jsonResult = JSON.parse(result);
                            if (jsonResult.success && jsonResult.transformedWkt) {
                                const transformedWkt = jsonResult.transformedWkt;
                                displayTransformResult(wkt, transformedWkt, sourceCoordSystem, targetCoordSystem);
                            } else {
                                showError(`âŒ è½¬æ¢å¤±è´¥: ${jsonResult.message || 'æœªçŸ¥é”™è¯¯'}`);
                            }
                        } catch (e) {
                            showError(`âŒ è§£æå“åº”å¤±è´¥: ${result}`);
                        }
                    } else {
                        // æ­£å¸¸çš„WKTæ ¼å¼ç»“æœ
                        displayTransformResult(wkt, result, sourceCoordSystem, targetCoordSystem);
                    }
                } else {
                    const errorText = await response.text();
                    showError(`âŒ è½¬æ¢å¤±è´¥: ${errorText}`);
                }
            } catch (error) {
                showError(`âŒ è¯·æ±‚å¤±è´¥: ${error.message}`);
            }
        }

        // æ‰¹é‡åæ ‡è½¬æ¢
        async function batchTransform() {
            const batchText = document.getElementById('batchCoords').value;
            if (!batchText.trim()) {
                showError('è¯·è¾“å…¥æ‰¹é‡åæ ‡æ•°æ®');
                return;
            }

            const sourceCoordSystem = document.getElementById('sourceCoordSystem').value;
            const targetCoordSystem = document.getElementById('targetCoordSystem').value;

            if (sourceCoordSystem === targetCoordSystem) {
                showError('æºåæ ‡ç³»å’Œç›®æ ‡åæ ‡ç³»ç›¸åŒï¼Œæ— éœ€è½¬æ¢');
                return;
            }

            // è§£æåæ ‡æ•°æ®
            const lines = batchText.trim().split('\n');
            const coordinates = [];

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                if (line) {
                    const parts = line.split(',');
                    if (parts.length >= 2) {
                        const x = parseFloat(parts[0].trim());
                        const y = parseFloat(parts[1].trim());
                        if (!isNaN(x) && !isNaN(y)) {
                            coordinates.push({ x, y });
                        }
                    }
                }
            }

            if (coordinates.length === 0) {
                showError('æ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„åæ ‡æ•°æ®');
                return;
            }

            try {
                const results = [];
                let successCount = 0;

                for (const coord of coordinates) {
                    const wkt = `POINT(${coord.x} ${coord.y})`;

                    const response = await fetch('/api/coordinate/transform', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            wkt: wkt,
                            sourceCoordSystem: sourceCoordSystem,
                            targetCoordSystem: targetCoordSystem
                        })
                    });

                    if (response.ok) {
                        const result = await response.text();

                        // æ£€æŸ¥æ˜¯å¦æ˜¯JSONæ ¼å¼çš„é”™è¯¯å“åº”
                        if (result.startsWith('{') && result.includes('transformedWkt')) {
                            try {
                                const jsonResult = JSON.parse(result);
                                if (jsonResult.success && jsonResult.transformedWkt) {
                                    const transformedWkt = jsonResult.transformedWkt;
                                    const success = transformedWkt !== wkt;
                                    if (success) successCount++;
                                    results.push({
                                        input: wkt,
                                        output: transformedWkt,
                                        success: success
                                    });
                                } else {
                                    results.push({
                                        input: wkt,
                                        output: `é”™è¯¯: ${jsonResult.message || 'è½¬æ¢å¤±è´¥'}`,
                                        success: false
                                    });
                                }
                            } catch (e) {
                                results.push({
                                    input: wkt,
                                    output: `è§£æé”™è¯¯: ${result}`,
                                    success: false
                                });
                            }
                        } else {
                            // æ­£å¸¸çš„WKTæ ¼å¼ç»“æœ
                            const success = result !== wkt;
                            if (success) successCount++;
                            results.push({
                                input: wkt,
                                output: result,
                                success: success
                            });
                        }
                    } else {
                        const errorText = await response.text();
                        results.push({
                            input: wkt,
                            output: `HTTPé”™è¯¯: ${errorText}`,
                            success: false
                        });
                    }
                }

                const sourceInfo = coordSystemInfo[sourceCoordSystem];
                const targetInfo = coordSystemInfo[targetCoordSystem];

                showSuccess(`âœ… æ‰¹é‡è½¬æ¢å®Œæˆï¼\n\nğŸ“Š è½¬æ¢ç»Ÿè®¡: ${successCount}/${results.length} ä¸ªåæ ‡è½¬æ¢æˆåŠŸ\nğŸ“ æºåæ ‡ç³»: ${sourceInfo.usage}\nğŸ“ ç›®æ ‡åæ ‡ç³»: ${targetInfo.usage}\n\nè¯¦ç»†ç»“æœè¯·æŸ¥çœ‹ä¸‹æ–¹åˆ—è¡¨`);

                displayBatchResult(results, sourceInfo, targetInfo);

            } catch (error) {
                showError('âŒ æ‰¹é‡è½¬æ¢å¤±è´¥: ' + error.message);
            }
        }

        // æ˜¾ç¤ºæ‰¹é‡è½¬æ¢ç»“æœ
        function displayBatchResult(results, sourceInfo, targetInfo) {
            const resultContainer = document.getElementById('resultContainer');
            let html = `
                <div class="success">æ‰¹é‡è½¬æ¢ç»“æœ</div>
                <div style="margin: 15px 0; padding: 10px; background-color: #f8f9fa; border-radius: 4px;">
                    <strong>è½¬æ¢é…ç½®:</strong><br>
                    æºåæ ‡ç³»: ${sourceInfo.usage}<br>
                    ç›®æ ‡åæ ‡ç³»: ${targetInfo.usage}
                </div>
                <div style="max-height: 400px; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead style="background-color: #f8f9fa; position: sticky; top: 0;">
                            <tr>
                                <th style="padding: 10px; border: 1px solid #ddd; text-align: left;">åºå·</th>
                                <th style="padding: 10px; border: 1px solid #ddd; text-align: left;">åŸå§‹åæ ‡</th>
                                <th style="padding: 10px; border: 1px solid #ddd; text-align: left;">è½¬æ¢ç»“æœ</th>
                                <th style="padding: 10px; border: 1px solid #ddd; text-align: center;">çŠ¶æ€</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            results.forEach((result, index) => {
                const statusIcon = result.success ? 'âœ…' : 'âŒ';
                const statusText = result.success ? 'æˆåŠŸ' : 'å¤±è´¥';
                html += `
                    <tr>
                        <td style="padding: 8px; border: 1px solid #ddd;">${index + 1}</td>
                        <td style="padding: 8px; border: 1px solid #ddd; font-family: monospace;">${result.input}</td>
                        <td style="padding: 8px; border: 1px solid #ddd; font-family: monospace;">${result.output}</td>
                        <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${statusIcon} ${statusText}</td>
                    </tr>
                `;
            });

            html += `
                        </tbody>
                    </table>
                </div>
            `;

            resultContainer.innerHTML = html;
        }

        // æ¸…ç©ºè¾“å…¥
        function clearInputs() {
            document.getElementById('inputX').value = '';
            document.getElementById('inputY').value = '';
            document.getElementById('batchCoords').value = '';
            document.getElementById('resultContainer').innerHTML = '<p>ç­‰å¾…è½¬æ¢ç»“æœ...</p>';
        }

        // æ˜¾ç¤ºè½¬æ¢ç»“æœ
        function displayTransformResult(originalWkt, transformedWkt, sourceCoordSystem, targetCoordSystem) {
            const sourceInfo = coordSystemInfo[sourceCoordSystem];
            const targetInfo = coordSystemInfo[targetCoordSystem];

            // è§£æåæ ‡
            const originalCoords = parseWktCoordinates(originalWkt);
            const transformedCoords = parseWktCoordinates(transformedWkt);

            const resultContainer = document.getElementById('resultContainer');
            resultContainer.innerHTML = `
                <div class="success">âœ… åæ ‡è½¬æ¢æˆåŠŸï¼</div>
                <div style="margin: 20px 0; padding: 20px; background-color: #f8f9fa; border-radius: 8px; border-left: 4px solid #28a745;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                        <div style="padding: 15px; background-color: #e3f2fd; border-radius: 6px;">
                            <h4 style="margin: 0 0 10px 0; color: #1976d2;">ğŸ“ åŸå§‹åæ ‡</h4>
                            <div style="font-family: monospace; font-size: 14px; margin-bottom: 8px;">
                                <strong>X:</strong> ${originalCoords.x}<br>
                                <strong>Y:</strong> ${originalCoords.y}
                            </div>
                            <div style="font-size: 12px; color: #666;">
                                <strong>åæ ‡ç³»:</strong> ${sourceInfo.usage}<br>
                                <strong>ç±»å‹:</strong> ${sourceInfo.type}
                            </div>
                        </div>
                        <div style="padding: 15px; background-color: #e8f5e8; border-radius: 6px;">
                            <h4 style="margin: 0 0 10px 0; color: #2e7d32;">ğŸ“ è½¬æ¢ç»“æœ</h4>
                            <div style="font-family: monospace; font-size: 14px; margin-bottom: 8px;">
                                <strong>X:</strong> ${transformedCoords.x}<br>
                                <strong>Y:</strong> ${transformedCoords.y}
                            </div>
                            <div style="font-size: 12px; color: #666;">
                                <strong>åæ ‡ç³»:</strong> ${targetInfo.usage}<br>
                                <strong>ç±»å‹:</strong> ${targetInfo.type}
                            </div>
                        </div>
                    </div>
                    <div style="padding: 10px; background-color: #fff3e0; border-radius: 4px; font-size: 13px;">
                        <strong>ğŸ”„ è½¬æ¢æ–¹å‘:</strong> ${sourceCoordSystem} â†’ ${targetCoordSystem}
                    </div>
                </div>
            `;
        }

        // è§£æWKTåæ ‡
        function parseWktCoordinates(wkt) {
            try {
                const match = wkt.match(/POINT\(([^)]+)\)/);
                if (match) {
                    const coords = match[1].split(' ');
                    return {
                        x: parseFloat(coords[0]).toFixed(6),
                        y: parseFloat(coords[1]).toFixed(6)
                    };
                }
            } catch (e) {
                console.error('è§£æWKTå¤±è´¥:', e);
            }
            return { x: 'N/A', y: 'N/A' };
        }

        // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
        function showSuccess(message) {
            const resultContainer = document.getElementById('resultContainer');
            resultContainer.innerHTML = `<div class="success" style="white-space: pre-line;">${message}</div>`;
        }

        // æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
        function showError(message) {
            const resultContainer = document.getElementById('resultContainer');
            resultContainer.innerHTML = `<div class="error" style="white-space: pre-line;">${message}</div>`;
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            updateCoordSystemInfo();
        });
    </script>
</body>
</html>
